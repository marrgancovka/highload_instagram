# Проектирование высоконагруженных систем
Расчетно-пояснительная записка к курсовой работе по предмету "Проектирвоание высоконагруженных систем".  
## 1. Тема и целевая аудитория
### Тема
Instagram - социальная сеть для обмена фотографиями и видео
### Целевая аудитория
- Весь мир
- MAU: 2 млрд
### Функционал
- Публикация постов (фотографий и видео)
- Реакция на публикации (лайки и комментарии)
- Подписка на контент других пользователей
- Лента новостей
### Продуктовые решения
- Рекомендательный алгоритм на основе действий пользователя для показа инетерсного пользователю контента 
- Лента формируется на основе подписок пользователя и рекомендаций пользователю
- Хэштеги - для посика постов по тегам
## 2. Расчет нагрузки
### Продуктовые метрики
| Метрика                                                                 | Значение   |
|-------------------------------------------------------------------------|------------|
| Месячная аудитория                                                      | 2 млрд.    |
| Суточная аудитория*                                                     | 1,25 млрд. |
| Публикаций всего в день                                                 | 95 млн     |
| Среднее количество публикаций одним пользователем в день**              | 0,076      |
| Количество лайков одним пользователем в день                            | 8,4        |
| Среднее количество комментариев, оставляемых одним пользователем в день | 1          |
| Среднее время, проведенное в день                                       | 33,9 мин   |
*по [данным](https://backlinko.com/instagram-users) на 2017 год, mau = 800 млн., dau = 500 млн. (62,5% от mau). В 2024 mau составляет 2 млрд. человек. Возьмем такое же соотношение dau/mau, получим dau на 2024 год ```dau = 2 000 000 000 * 62,5% = 1 250 000 000```  
** ```95 000 000 / 1 250 000 000 = 0,076```
#### Средний размер хранилища пользователя по типам
Буду считать, что среднее время "жизни" пользователя равно 5 лет. 

| Тип                                         | Размер   |
|---------------------------------------------|----------|
| Данные пользователя (Имя, описание, аватар) | 1 Мб     |
| Подписки*                                   | 8 кб     |
| Лайки**                                     | 600 кб   |
| Комментарии***                              | 2 мб     |
| Публикации (фотографии + видео)****         | 1 057 мб |
*Большинство пользователей имеют от [1 000 до 10 000 подписчиков](https://backlinko.com/instagram-users#average-number-of-instagram-followers), 
количество подписок у пользователя значительно меньше. На основе анализа 50 активных пользователей Instagram: 
количество подписок находится в диапазоне от 1 до ~700, большинство пользователей имеет от 90 до 300 подписок. 
Исходя из этого возьму среднее количество подписок равное 200. Тогда размер подписок у пользователя будет равен: 
```200 * (16+16+8) = 8 000 байт ~ 8 кб```  
** ```5 лет * 365 дней * 8,4 лайка/день * 40 байт = 613 200 байт ~ 600 кб```  
*** Комментарий может содержать максимум 2 000 символов, но большинство комментариев содержит до 500 символов => возьму 500 символов, как среднее значение: 
```5 лет * 365 дней * 1 комм./день * (500*2 + 40) байт ~ 2 мб```  
****На основе данных из [marketingscoop.com](https://www.marketingscoop.com/blog/how-many-posts-are-posted-on-instagram-per-day/#:~:text=Photos%3A,and%20discovery%20pages) в день публикуется 48,2 млн фотографий в день и 22,8 млн видео в день, отсюда посчитаю соотношение 
```22,8/(48,2 + 22,8) * 100% = 32% от всего контента занимают видео```  
Учитывая, что источник предоставляет устаревшие данные, анализ 10 активных пользователей показал преобладание видео над фотографиями, и стремительно растущие тенденции к видеоконтенту (большая вовлеченность в видеоконтенте, короткие ролики, алгоритмы рекомендаций), 
то возьму соотношение видео к фото ```60 на 40```  
Количество публикаций у пользователя: ```5 лет * 365 дней * 0,076 публикаций/день ~ 140```  
[Битрейт](https://instaprofi.org/blog/interesnoe/parametry-video-v-instagram) видео составляет 3 000 кбит/с, средняя продолжительность ролика возьму 30 секунд, тогда средний размер видео ```3 000 кбит/c * 30 c ~ 11,25 мб ```  
**Размер** публикаций у пользователя ```(140 * 0,6) * 11,25 мб + (140 * 0,4) * 2 мб ~ 1057 мб ```
### Технические метрики
#### Размер хранения в разбивке по типам данных
| Тип                      | Количество, шт                                                  | Размер, ТБ |
|--------------------------|-----------------------------------------------------------------|------------|
| Фотографии + видеоролики | > 50 млрд.                                                      | 360 012*   |
| Данные профиля           | 2 млрд                                                          | 1 907**    |
| Лайки                    | ```2 млрд * 5 лет * 365 дней * 8,4 лайка/день = `30 660 млрд``` | 1 117***   | 
| Комментарии              | ```2 млрд * 5 лет * 365 дней * 1 комм./день = `3 650 млрд```    | 3 800****  | 
| Подписки                 | ```2 млрд * 200 = 400 млрд ```                                  | 15*****    | 

*Исходя из того, что видеоролики составляют примерно 60% от всех публикаций, получаем, что видеороликов примерно 30 млрд, и 20 млрд фотографий.   
Общий размер публикаций = количество видеороликов * средний размер видеоролика + количество фотографий * средний размер фотографии = `30 000 000 000 * 11,25 Мб + 20 000 000 000 * 2 Мб = 377 500 000 000 МБ = 
= 360 012 ТБ  
** 2 000 000 000 * 1 мб = 1 907 тб  
*** 600 кб * 2 млрд = 1 200 000 000 000 кб = 1 117 ТБ  
**** 2 мб * 2 млрд = 3 800 ТБ  
***** 2 млрд * 8 кб = 15 ТБ
#### Сетевой трафик
Так как Instagram используют по всему миру, то в разных часовых поясах будут разное пиковое время использования. Поэтому возьмем пиковое значение * 2 от среднесуточного. 
Расчет пикового значения - `(среднесуточное гбайт/сутки)*8/86400 * 2`

| Тип                                                    | Суточное, Гбайт/сутки | Пиковое, Гбит/с |
|--------------------------------------------------------|-----------------------|-----------------|
| Публикация фотографии                                  | 92 773 *              | 1 450           | 
| Публикация видео                                       | 521 850 **            | 8 154           |
| Проставление лайков                                    | 391 ***               | 6               |
| Комментирование                                        | 1 210 ****            | 19              |
| Просмотр публикаций (лента + публикации пользователей) | 2 770 996 093 *****   | 43 296 813      |

В сутки публикуется около 95 млн постов => 47,5 млн - видео, 47,5 млн - фотографии  
*`47,5 млн × 2 МБ = 92 773 Гбайт/сутки`  
** `47,5 млн × 11,25 МБ = 521 850 Гбайт/сутки`  
*** `1,25 млрд * 8,4 * 40 байт = 391 Гбайт/сутки`  
**** `1,25 млрд * 1 * (500*2 + 40) байт = 1 210 Гбайт/сутки`  
***** [Большинство пользователей используют платформу для развлечения](https://sproutsocial.com/insights/instagram-stats/).
Развлечением многие считают просмотр коротких роликов длительностью 10-30 секунд. Для расчета трафика просмотра публикаций возьму следующие данные:
 - пользователь 90% времени смотрит короткие ролики длительностью в среднем 20 секунд, и в минуту успевает посмотреть около 7 роликов
 - остальные 10% времени пользователи смотрит фотографии в ленте или в профиле другого пользователя, успевая посмотреть в минуту около 20 фотографий
 - пользователь в среднем в день проводит на платформе 33,9 минуты  

`(33,9 * 0,9) * 10 мб * 7 + (33,9 * 0,1) * 2 мб * 20 = 2 270 мб`  
`2 270 мб * 1,25 млрд = 2 770 996 093 Гбайт/сутки`
#### RPS
Расчет пикового значения - `(среднесуточное rps) * 2`

| Тип                   | Суточное, запросов в секунду | Пиковое, запросов в секунду |
|-----------------------|------------------------------|-----------------------------|
| Публикация фотографии | 430                          | 860                         | 
| Публикация видео      | 645                          | 1290                        |
| Просмотр публикаций   | 4 065 393                    | 8 130 786                   |
| Комментирование       | 14 467                       | 28 934                      |
| Проставление лайков   | 121 528                      | 243 056                     |

В секунду публикуется 1074 поста => 645 видео, 430 фото  
`((33,9 * 0,9) * 7 + (33,9 * 0,1) * 20) * 1,25 млрд / 86400 = 4 065 393`
`1,25 млрд / 86400 = 14 467`  
`1,25 млрд * 8,4 / 86400 = 121 528`

## 3. Глобальная балансировка нагрузки
### Расположение ДЦ
Instagram - приложение, которое используют по всему миру. 
Странами с наибольшим количеством активных аккаунтов, являются Индия ( 385,35 млн пользователей), США (166,15 млн), Бразилия (133,05 млн), Индонезия (99,4 млн) и Турция (58,45 млн).  
Поэтому расположим дата-центры так, чтобы обеспечить в этих местах хорошую связь.  
1. Азия
* Мумбаи (Индия)
* Стамбул (Турция)
2. Северная Америка
* Нью-Джерси
* Сан-Франциско
3. Южная Америка
* Сан-Паулу (Бразилия)
4. Европа
* Амстердам (Нидерланды)
* Варшава (Польша)
### Глобальная балансировка
Для обеспечения эффективной балансировки нагрузки для приложения, которое используется по всему миру хорошим решением будет использовать:
* GeoDNS - будет направлять запросы на ближайший ДЦ

## 4. Локальная балансировка
## 5. Логическая схема БД
## 6. Физическая схема БД


## Источники
1. https://sproutsocial.com/insights/instagram-stats/
2. https://whatsthebigdata.com/instagram-statistics/
3. https://www.socialpilot.co/instagram-marketing/instagram-stats
4. https://earthweb.com/blog/how-many-pictures-are-on-instagram/
5. https://www.statista.com/topics/1882/instagram/#topicOverview
